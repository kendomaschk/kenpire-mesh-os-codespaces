# KenPire Mesh OS - Monitoring Stack
# Prometheus, Grafana, and alerting configuration

apiVersion: v1
kind: ServiceMonitor
metadata:
  name: kenpire-mesh-os-monitor
  namespace: kenpire-mesh-os
  labels:
    app: kenpire-mesh-os
spec:
  selector:
    matchLabels:
      app: kenpire-mesh-os
      component: api-server
  endpoints:
  - port: http
    path: /metrics
    interval: 30s

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-kenpire
  namespace: monitoring
data:
  kenpire-dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "KenPire Mesh OS Dashboard",
        "tags": ["kenpire", "mesh-os"],
        "timezone": "UTC",
        "panels": [
          {
            "title": "API Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{service=\"kenpire-mesh-os\"}[5m])",
                "legendFormat": "Requests/sec"
              }
            ]
          },
          {
            "title": "Response Time",
            "type": "graph", 
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service=\"kenpire-mesh-os\"}[5m]))",
                "legendFormat": "95th percentile"
              }
            ]
          },
          {
            "title": "Error Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(http_requests_total{service=\"kenpire-mesh-os\",status=~\"4..|5..\"}[5m])",
                "legendFormat": "Error rate"
              }
            ]
          },
          {
            "title": "Pod Status",
            "type": "table",
            "targets": [
              {
                "expr": "up{service=\"kenpire-mesh-os\"}",
                "legendFormat": "Pod {{instance}}"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }

---

apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: kenpire-mesh-os-alerts
  namespace: kenpire-mesh-os
spec:
  groups:
  - name: kenpire.rules
    rules:
    - alert: KenPireHighErrorRate
      expr: rate(http_requests_total{service="kenpire-mesh-os",status=~"4..|5.."}[5m]) > 0.1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High error rate for KenPire Mesh OS"
        description: "Error rate is {{ $value }} errors per second"
    
    - alert: KenPireHighLatency
      expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{service="kenpire-mesh-os"}[5m])) > 1.0
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High latency for KenPire Mesh OS"
        description: "95th percentile latency is {{ $value }}s"
    
    - alert: KenPirePodsDown
      expr: up{service="kenpire-mesh-os"} < 2
      for: 1m
      labels:
        severity: critical
      annotations:
        summary: "KenPire Mesh OS pods are down"
        description: "Only {{ $value }} pods are running"
    
    - alert: KenPireHighMemoryUsage
      expr: container_memory_usage_bytes{pod=~"kenpire-mesh-os-.*"} / container_spec_memory_limit_bytes > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High memory usage for KenPire Mesh OS"
        description: "Memory usage is {{ $value | humanizePercentage }}"
    
    - alert: KenPireHighCPUUsage
      expr: rate(container_cpu_usage_seconds_total{pod=~"kenpire-mesh-os-.*"}[5m]) / container_spec_cpu_quota * container_spec_cpu_period > 0.8
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High CPU usage for KenPire Mesh OS"
        description: "CPU usage is {{ $value | humanizePercentage }}"

---

apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: kenpire-mesh-os
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         1
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020

    [INPUT]
        Name              tail
        Path              /var/log/containers/kenpire-mesh-os-*.log
        Parser            docker
        Tag               kenpire.*
        Refresh_Interval  5
        Mem_Buf_Limit     50MB

    [FILTER]
        Name                kubernetes
        Match               kenpire.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kenpire.
        Merge_Log           On
        Keep_Log            Off

    [OUTPUT]
        Name  es
        Match *
        Host  elasticsearch
        Port  9200
        Index kenpire-logs
        Type  _doc

  parsers.conf: |
    [PARSER]
        Name   docker
        Format json
        Time_Key time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

---

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: kenpire-mesh-os
spec:
  selector:
    matchLabels:
      name: fluent-bit
  template:
    metadata:
      labels:
        name: fluent-bit
    spec:
      serviceAccount: fluent-bit
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:latest
        ports:
        - containerPort: 2020
        env:
        - name: FLUENT_ELASTICSEARCH_HOST
          value: "elasticsearch"
        - name: FLUENT_ELASTICSEARCH_PORT
          value: "9200"
        volumeMounts:
        - name: varlog
          mountPath: /var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
        - name: fluent-bit-config
          mountPath: /fluent-bit/etc/
      terminationGracePeriodSeconds: 10
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
      - name: fluent-bit-config
        configMap:
          name: fluent-bit-config